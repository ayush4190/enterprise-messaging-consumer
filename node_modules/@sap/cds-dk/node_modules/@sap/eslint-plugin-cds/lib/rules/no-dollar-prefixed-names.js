const { isVSCodeEditor } = require("../utils/helpers");

module.exports = {
  meta: {
    docs: {
      description: `Names must not start with $ to avoid possible shadowing of reserved variables.`,
      category: "Model Validation",
      recommended: true,
      version: "2.3.3",
    },
    severity: "warn",
  },
  create(context) {
    return { element: _check };

    function _check(d) {

      // Do not blame in case of external services
      let srv = d._service || (d.parent && d.parent._service);
      if (srv && srv["@cds.external"]) return;

      const results = [];
      for (const m in context.cds.model.messages) {
        const msg = context.cds.model.messages[m];
        if (msg.messageId === "syntax-dollar-ident" && !isVSCodeEditor()) {
          results.push({
            message: msg.message,
            loc: {
              start: { line: msg.location.line, column: msg.location.col - 1 },
              end: {
                line: msg.location.endLine,
                column: !msg.location.endCol
                          ? context.sourcecode.lines[msg.location.line - 1].length 
                          : msg.location.endCol - 1,
              },
            },
            file: msg.location.file,
          });
        }
      }

      if (d.name.startsWith("$")) {
        // Do blame
        results.push(`“${d.name}” is prefixed with a dollar sign ($)`);
      }
      return results.length > 0 ? results : undefined;
    }
  },
};
